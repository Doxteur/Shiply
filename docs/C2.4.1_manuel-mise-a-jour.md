## Manuel de mise à jour (C2.4.1)

Ce document explique, de manière simple et concrète, comment préparer et publier une nouvelle version de Shiply. L’objectif est de garder un processus clair, traçable et reproductible.

En bref, le fonctionnement s’appuie sur:
- GitFlow avec des branches `release/*` créées depuis `develop` et un versionnage sémantique (SemVer);
- un changelog généré automatiquement à partir des Conventional Commits;
- des images Docker publiées sur Docker Hub (API et front), tirées par `docker-compose.prod.yml` en production;
- une CI qui valide typecheck, lint, tests (≥ 80% sur les modules modifiés) et contrôles qualité/sécurité.

Prérequis essentiels:
- un fichier `.env` à la racine avec la variable `HOST_WORKSPACE_DIR` (voir manuel de déploiement pour les valeurs Windows/Linux);
- un `server/.env` complet (au minimum `APP_KEY` et les variables `DB_*`);
- accès Docker et au serveur cible.

Déroulé d’une release:
1) Préparer la branche de release et générer le changelog
```
git checkout develop && git pull --ff-only
git checkout -b release/x.y.z
npx --yes conventional-changelog-cli -p angular -i CHANGELOG.md -s
git add CHANGELOG.md && git commit -m "docs(changelog): update for x.y.z"
git push -u origin release/x.y.z
```
– Ouvrir une PR vers `main` (titre « release: x.y.z », résumé des changements et risques).

2) Publier la version (après merge sur `main`)
```
git checkout main && git pull --ff-only
git tag -a vx.y.z -m "release vx.y.z"
git push origin vx.y.z
```
– La CI pousse les images Docker Hub:
  - API: `doxteurn/shiply-api:vx.y.z`
  - Web: `doxteurn/shiply-nginx:vx.y.z`

3) Mettre à jour la production
– La CI/CD se charge automatiquement du déploiement après le push du tag:
  - Pull des nouvelles images Docker
  - Redémarrage des services via docker-compose
  - Vérification de l'état de santé
  - Front accessible sur https://shiply-app.fr/ une fois terminé

4) Ré-aligner les branches
```
git checkout develop && git pull --ff-only
git merge --no-ff main -m "merge(main): back-merge release x.y.z into develop"
git push
```
– Évite toute divergence entre `develop` et `main` après la sortie.

Points d’attention:
- Base de données: les migrations sont versionnées et réversibles. Une sauvegarde avant montée de version est recommandée. En cas de besoin: `node ace migration:rollback` dans le conteneur API.
- Environnement Windows: si Docker n’est pas joignable, exposer le daemon TCP dans Docker Desktop et définir `DOCKER_HOST=tcp://localhost:2375`. La valeur de `HOST_WORKSPACE_DIR` est détaillée dans le manuel de déploiement.
