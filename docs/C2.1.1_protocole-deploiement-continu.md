## Protocole de déploiement continu (C2.1.1)

### Objectifs
- Assurer des déploiements fiables et fréquents vers des environnements contrôlés.
- Réduire le temps moyen de restauration (MTTR) et le taux d’échec des changements.
- Fournir une traçabilité complète (versions, changelog, historique des déploiements).

### Environnement de développement
- Poste de dev: Windows 11 (Git Bash/PowerShell), Docker Desktop, Node 20 LTS.
- Éditeur: VS Code avec extensions ESLint, Prettier, TailwindCSS IntelliSense, Docker, GitHub Actions, YAML.
- Gestion de sources: Git + GitHub, stratégie GitFlow (branches `main`, `develop`, `feature/*`, `release/*`, `hotfix/*`).
- Gestion paquets/monorepo: Yarn Workspaces + `turbo` (orchestration).
- Démarrage dev: `bun install` puis `bun run dev` (serveur avant runner).

### Environnements ciblés
- **Dev**: exécution locale via `docker-compose.dev.yml`. Données volatiles. Auth simplifiée.
- **Staging**: proche de la prod, gates manuels activables, smoke-tests systématiques.
- **Production**: disponibilité prioritaire, rollback rapide. Reverse proxy géré par **Nginx Proxy Manager** (NPM) pour DNS/SSL.

### Outils et briques
- Orchestrateur interne: **Shiply Deploy Manager** (drivers `compose`, `dockerfile`, `command`).
- Conteneurisation: **Docker** et `docker-compose`.
- Base de données: **MySQL**.
- Observabilité: **/metrics** Prometheus + tableau de bord Grafana.
- Sécurité: headers via Helmet, CORS strict, Rate limit.
- Compilateur/Transpileur: **TypeScript** (`tsc`) + Vite (esbuild/rollup) côté client.
- Serveurs d’application:
  - **API**: AdonisJS (Node.js 20) – serveur HTTP, Lucid ORM, JWT.
  - **Front**: Vite dev server en dev; Nginx en prod (serving statique).
- Outils de gestion de sources: Git, GitHub, protections de branches et "PR obligatoires".

### Périmètre et flux de déploiement
Il existe deux périmètres distincts à ne pas confondre:

1) Déploiement de Shiply (self‑hosting de la plateforme)
   - Objectif: faire tourner Shiply lui‑même sur mon serveur.
   - Outils: `docker-compose.prod.yml` + **Nginx Proxy Manager**.
   - Flux minimal:
     1. Préparer `server/.env.prod` (clés, DB, JWT).
     2. Lancer Shiply: `docker compose -f docker-compose.prod.yml up -d --build`.
     3. Créer un Proxy Host dans NPM vers le service Nginx qui à été configuré dans le docker-compose.prod.yml.
     4. Vérifier l’accès UI (domaine) et l’API (via le proxy).

2) Déploiement d’applications cibles via Shiply (projets utilisateurs)
   - Objectif: déployer mes applications pilotées par les pipelines Shiply.
   - Outils: **Shiply Deploy Manager** et ses drivers (dans le workspace projet):
   Il existe 3 façons de déployer une application sur shiply:
   - `compose`: `docker compose -f <composePath> up -d`.
   - `dockerfile`: `docker build` + `docker run`/compose minimal.
   - `command`: exécution d’un `startCommand`.

### Conditions d'acceptation / Gates
- Gate manuel obligatoire sur **Production**.
- Vérification des checks qualité/sécurité via SonarQube:
  - Qualité du code (code smells, duplications)
  - Dette technique
  - Vulnérabilités de sécurité
  - Couverture des tests (≥80% sur modules touchés)
- Secrets présents et valides.

### Versioning et traçabilité
- Versioning via GitFlow: `main` (immuable, versions `vX.Y.Z`), `develop`, `feature/*`, `release/*`, `hotfix/*`.
- Tags SemVer sur `main`.

### Stratégies de rollback
- Applications stateless: redéploiement de l’image/version précédente (driver dépendant).
- Bases de données: migrations réversibles, sauvegardes programmées (non présent sur le MVP).
- Actions UI: bouton « Rollback » depuis l’historique des déploiements (non présent sur le MVP).

### Critères de qualité et de performance
- Qualité code: TypeScript strict, ESLint/Prettier OK, conventions de commits respectées.
- Tests: couverture ≥ 80%.
- Sécurité: 0 vulnérabilité critique/haute sur artefacts de release (Trivy)
- Performance UI (Lighthouse CI): Perf ≥ 80, A11y ≥ 85, Best Practices ≥ 90.
- Observabilité: logs de déploiement disponibles en temps réel (<2s de latence moyenne SSE), métriques /metrics exposées.
- Déploiement: temps de mise en prod typique < 4 min (hors build d’images lourdes).

### Références
- Voir `docs/C2.1.2_protocole-integration-continue.md` pour le détail CI.
- Voir `docs/shiply-deploy-manager.md` pour les drivers de déploiement.

