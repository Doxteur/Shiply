## Manuel de déploiement (C2.4.1)

Ce document présente simplement comment déployer Shiply en développement et en production. L’idée est de garder une démarche claire, avec quelques points clés et des commandes prêtes à l’emploi.

Principes généraux:
- Shiply se compose d’une API (AdonisJS), d’un front servi par Nginx et d’un runner qui exécute les jobs.
- Les images de prod sont tirées depuis Docker Hub et orchestrées via `docker-compose.prod.yml`.
- La configuration s’appuie sur deux fichiers d’environnement: un `.env` à la racine (chemin de workspace) et un `server/.env` pour l’API.

### Pré-requis
- Docker installé et accessible.
- Accès MySQL (hôte/port/utilisateur/mot de passe/base) et ports réseau ouverts (de mon coté j'utilise spleendb.fr, une application que j'ai développée pour créer des bases de données).
- Sous Windows, Docker Desktop peut nécessiter l’exposition du daemon TCP (`DOCKER_HOST`, voir Dépannage).

### Configuration des environnements (.env)

Racine du projet (`.env`):
```
# Windows (Docker Desktop)
HOST_WORKSPACE_DIR=/run/desktop/mnt/host/d/Dev/Perso/deploy

# Linux
HOST_WORKSPACE_DIR=/app/deploy
```

API (`server/.env`):
```
NODE_ENV=production
HOST=0.0.0.0
PORT=3333

# Clé d’application (obligatoire) peut etre générée avec la commande `node ace key:generate`
APP_KEY=base64:...ou:hex...
APP_NAME=Shiply
LOG_LEVEL=info

# Base de données MySQL
DB_HOST=your_mysql_host
DB_PORT=3306
DB_USER=your_user
DB_PASSWORD=your_password
DB_DATABASE=shiply

# (Optionnel) Intégration GitHub OAuth
GITHUB_CLIENT_ID=
GITHUB_CLIENT_SECRET=
GITHUB_CALLBACK_URL=
```

### Déploiement local (dev)
- Installer les dépendances à la racine, lancer le compose de dev (si présent), puis démarrer le mono‑repo.
```
bun install
docker compose -f docker-compose.dev.yml up -d
bun run dev
```

### Déploiement production (images publiées)

1) Préparer l’environnement :
```
# .env (racine du projet)
# Windows
echo HOST_WORKSPACE_DIR=/run/desktop/mnt/host/d/Dev/Perso/deploy > .env
# Linux
echo HOST_WORKSPACE_DIR=/app/deploy > .env

# .env API
# Créer/éditer server/.env (voir section Configuration des environnements)
```

2) Tirer les images et démarrer les services:
```
docker compose -f docker-compose.prod.yml pull
docker compose -f docker-compose.prod.yml up -d --remove-orphans
```

3) Appliquer les migrations de base de données (dans le conteneur API):
```
docker exec -it shiply-api-prod node ace migration:run --force
```

4) Vérifier la santé applicative:
```
curl -f http://localhost:12001/health || exit 1
# Front: http://localhost:12002
```

Notes utiles:
- `docker-compose.prod.yml` utilise par défaut `doxteurn/shiply-api:latest` et `doxteurn/shiply-nginx:latest`.

### Dépannage
- Docker non joignable: vérifier socket/pipe/TCP et éventuellement définir `DOCKER_HOST=tcp://localhost:2375` (Windows).
- Logs vides: vérifier SSE et permissions d’écriture dans `server/storage/logs/jobs/`.
- Base de données:
  - Authentification: contrôler `DB_USER/DB_PASSWORD` et les droits.
  - Réseau: s’assurer que l’hôte MySQL est joignable depuis le conteneur API.
- APP_KEY manquante: générer une nouvelle clé et redémarrer l’API.
- Workspace: le répertoire mappé dans `WORKSPACE_DIR` doit exister côté hôte et être accessible en lecture/écriture.
